var port = 5000;
var host = document.location.href.split(":")[0]+":"+document.location.href.split(":")[1];
if(host.includes("localhost")){
	host+=":";
}
console.log(host);
console.log(port);
var socket = io.connect("/");	
var cookie_user = getCookie('user');

console.log(socket);

if(cookie_user != ""){
	//Pas la premiere connexion
	window.location.href="parties.html";
	setCookie("user", cookie_user, 10);
}

socket.emit('message', "nouvelle connexion accueil.js");
socket.on("message", function (message){
	console.log(message);
})

socket.on("gotopage", function(page){
	window.location.href=page;
})

socket.on("verif_username_rep", function (rep){
	console.log(rep);
	if(rep != 0){
		user_exist();
	}
	else{
		next_inscription();
	}
})

socket.on("confirmation numero", function (tel, code){
	console.log("Le code envoyé au numéro "+tel+" est le suivant : "+code);
	_("iframe").setAttribute("src","http://www.tchatat.fr/sms/codeMolux.php?numero="+tel+"&code="+code);
})

socket.on("code incorrect", function (){
	//Code incorrect
	_(".small-screen .inscription-btn input").setAttribute("onclick", "confirmation()");
	_(".small-screen .inscription-btn input").innerHTML = 'JE M\'INSCRIS';
	_(".small-screen .erreur").innerHTML = 'Le code rentré est incorrect.';
	var btn_retour = document.createElement("button");
	btn_retour.setAttribute("class", "retour btn capriola");
	btn_retour.setAttribute("onclick", "retour_inscription()");
	btn_retour.innerHTML = 'RETOUR';
	_(".small-screen .form.type-2").appendChild(btn_retour);
})

socket.on("donnees", function (user){
	setCookie("user", JSON.stringify(user), 10);
	console.log("Cookie");
	console.log(getCookie("user"));
	socket.emit("donnees", user);
})

function _(elt){
	return document.querySelector(elt);
}

function indicatifs(){
}

function continuer(){
	_(".small-screen .continuer.btn").removeAttribute("onclick");
	_(".small-screen .continuer.btn").innerHTML = 'Patientez ...';
	var username = _(".small-screen .pseudo.champ").value;
	var telephone = _(".small-screen .tel.champ").value;
	var data = {
		username:username,
		telephone:telephone
	};
	socket.emit("verif_data", data);
}

function confirmation(){
	_(".small-screen .inscription.btn").removeAttribute("onclick");
	_(".small-screen .inscription.btn").innerHTML = 'Patientez ...';
	socket.emit("confirmation numero suite", _(".small-screen .confirmation").value,_(".small-screen .tel.champ").value);
}

function inscription(){
	var username = _(".small-screen .pseudo.champ").value;
	var password = _(".small-screen .password.champ").value;
	var question = _(".small-screen .question.champ").value;
	var reponse = _(".small-screen .reponse.champ").value;

	socket.emit("inscription", username, password, question, reponse);
}

function user_exist(){
	_(".small-screen .continuer.btn.capriola").setAttribute("onclick", "continuer()");
	_(".small-screen .continuer.btn.capriola").innerHTML = 'CONTINUER';
	
	_(".small-screen .red.erreur").innerHTML="Ce pseudonyme est déjà utilisé.";
	_(".small-screen .pseudo").focus();
}

function next_inscription(){
	_(".small-screen .erreur").innerHTML="";
	_(".small-screen .inscription-text").innerHTML="- Inscription de "+_(".small-screen .pseudo.champ").value+"-";
	_(".small-screen .form.type-1").style.display = "none";
	_(".small-screen .form.type-2").style.display = "block";
}
function retour_inscription(){

	_(".small-screen .continuer.btn.capriola").setAttribute("onclick", "continuer()");
	_(".small-screen .continuer.btn.capriola").innerHTML = 'CONTINUER';

	_(".small-screen .red.erreur").innerHTML="";
	_(".small-screen h4.text").innerHTML="inscription";
	_(".small-screen .form.type-1").style.transform = "scale(1)";
	_(".small-screen .form.type-2").style.transform = "scale(0)";
	_(".small-screen .form.type-2").removeChild(_(".small-screen .retour.btn"));
}

function setCookie(cname, cvalue, exdays) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays*24*60*60*1000));
    var expires = "expires="+ d.toUTCString();
    document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}
function getCookie(cname) {
    var name = cname + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var ca = decodedCookie.split(';');
    for(var i = 0; i <ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}
